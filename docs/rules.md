# Rules, Conventions, Refactoring Playbook

## Rules

### Setup idempotency
Setup / configure scripts must be idempotent.
They should be safe to run multiple times and always converge the system to the same desired state. Re-running them must not duplicate work, corrupt configuration, or produce different results.

### Code generation for Linux packages setup scripts
The distro setup scripts (`linux/configure_packages_debian.sh` and `linux/configure_packages_arch.sh`) are generated by `linux/generate_distro_package_setup_code.sh`.

This avoids duplication by defining shared and distro-specific packages in `linux/*.txt` files. The generator consolidates shared packages and applies distro-specific differences, producing the appropriate install script for each platform.

### Merge rules (shell profiles)
- Linux/macOS: Use `append_or_merge_file` for `~/.bash_profile`, `~/.bashrc`, `~/.zshrc`.
- Windows: Avoid breaking `$PROFILE` injection logic (it searches for `SetEnv.ps1` and appends if missing).
- Merge should be line-based and avoid duplication.
- Keep “local overrides” last in load order.

### Cross-platform rules (for changes)
- Don’t assume a tool exists on all OSes.
- Prefer feature detection (`command -v`, `Test-Path`) over OS-only branching when reasonable.
- If you add a new dependency:
  - decide how it installs on brew/apt/pacman/choco
  - update the OS scripts accordingly
  - ensure re-run behavior is safe

### Adding a new "*nix" component (pattern)
1. Create `component/configure_component.sh`
2. Script should:
   - source `setup/setup_functions.sh`
   - install dependencies per OS (brew/apt/pacman)
   - link config files into expected locations
   - be safe to re-run
3. Add a call in `setup/setup.sh` in the appropriate sequence.

## Conventions

### Bash scripting conventions
- Use `#!/usr/bin/env bash`
- Determine repo root consistently: `dotdir="$(cd "$(dirname "$0")/.." && pwd)"`
- Source helpers early: `source "$dotdir/setup/setup_functions.sh"`
- OS detection:
  - `os=$(uname -s)`
  - Linux distro detection via presence of package manager (`apt-get`, `pacman`)

### Logging
- Use `dot_trace "message"` for normal steps.
- Use `dot_error "message"` for failures.
- Logs go to:
  - terminal (colored)
  - `~/.dotfiles_history` (persistent)

### Symlinks (Unix)
- Use the helper symlink function (not raw `ln -s`) so backups are consistent.
- Backup behavior: existing target is moved to `target.timestamp` before linking.


## Refactor Playbook (Safe Changes)

### Goals
- Keep bootstrap scripts runnable and re-runnable.
- Preserve local customization hooks.
- Avoid cross-platform regressions.

### Risk classification
High risk:
- `setup/setup.sh`, `setup/setup_functions.sh`
- `setup/setup.ps1`, `windows/SetEnv.ps1`
- Anything that edits user profile files (`~/.bashrc`, `$PROFILE`)

Medium risk:
- OS package scripts (`linux/configure_packages_*`, `osx/configure_osx.sh`)
- Vim/tmux plugin installers (network + mutation)

Low risk:
- Adding new aliases/functions in dedicated dotfiles (if load order preserved)

### Process
1) Identify which OS(es) the change impacts.
2) Confirm load order and injection points:
   - shell profiles merge
   - symlink sources
   - local overrides remain last
3) Make the smallest change that preserves patterns (helpers, logging, idempotence).
4) Validate locally (at minimum):
   - Bash: `shellcheck` on changed scripts
   - PowerShell: syntax check / run in a clean session if possible
   - Ensure no duplicated lines in profiles after re-run
5) Document the change (brief note in commit message or docs).

### Validation checklist (Unix)
- `setup/setup.sh` still detects OS correctly.
- `~/.dotfiles_history` still logs.
- Re-run does not:
  - duplicate merged lines
  - break symlink targets
- Local override hooks still load last.

### Validation checklist (Windows)
- `setup/setup.ps1` still:
  - installs packages
  - clones/pulls repo
  - ensures `$PROFILE` sources `SetEnv.ps1` exactly once
- `SetEnv.ps1`:
  - does not error if optional modules aren’t installed
  - still sources `$Home\profile.ps1` if present
